# üìò Database Documentation ‚Äî `OPERATION MS`

> Inspirado en convenciones usadas por equipos grandes (dbdocs/dbdiagram, GitOps, CI/CD con migraciones). Este documento sirve como **fuente √∫nica de verdad** para desarrolladores, QA, DevOps y analistas.

---

## üß≠ Tabla de contenido
- [Resumen](#-resumen)
- [Esquema l√≥gico](#-esquema-l√≥gico)
- [Tablas](#-tablas)
    - [Money](#1-money)
    - [Currency](#2-currency)
    - [OperationType](#3-operationtype)
    - [Operations](#4-operations)
- [Relaciones](#-relaciones)
- [DDL can√≥nica](#-ddl-can√≥nica)
- [Convenciones y buenas pr√°cticas](#-convenciones-y-buenas-pr√°cticas)
- [√çndices recomendados](#-√≠ndices-recomendados)
- [Semillas (seed data)](#-semillas-seed-data)
- [Consultas de ejemplo](#-consultas-de-ejemplo)
- [Migraciones y CI/CD](#-migraciones-y-cicd)
- [Seguridad y accesos](#-seguridad-y-accesos)
- [Monitoreo y auditor√≠a](#-monitoreo-y-auditor√≠a)
- [Estrategias de pruebas](#-estrategias-de-pruebas)
- [Mejoras futuras (opcionales)](#-mejoras-futuras-opcionales)

---

## üîé Resumen
El sistema **Operation_Ms** gestiona saldos por cuenta y registra operaciones financieras entre dichos saldos, con soporte multimoneda. Se priorizan **tipos correctos** (p. ej., `DECIMAL` para dinero), **integridad referencial**, **auditor√≠a** (`created_at`, `updated_at`) y **portabilidad** mediante DDL versionado.

### Objetivos clave
- Representar saldos por **cuenta** y **moneda** (`Money`).
- Cat√°logo de **monedas** (`Currency`) y **tipos de operaci√≥n** (`OperationType`).
- Registro de **operaciones** entre saldos (`Operations`) con trazabilidad.

---

## üß± Esquema l√≥gico
![Esquema L√≥gico](../../../../assets/360-ms-operation.png)
```text
Currency (currency_code) ‚îÄ‚îÄ‚îÄ‚îÄ< Money (currency_code)

OperationType (operation_id) ‚îÄ‚îÄ‚îÄ‚îÄ< Operations (operation_type)

Money (money_id) ‚îÄ‚îÄ‚îÄ‚îÄ< Operations (money_master)
Money (money_id) ‚îÄ‚îÄ‚îÄ‚îÄ< Operations (money_secondary)
```
> Notaci√≥n `A ‚îÄ‚îÄ‚îÄ‚îÄ< B` = A (padre) a B (hijo) relaci√≥n 1:N.

---

## üìÇ Tablas

### 1) Money
Contiene los saldos asociados a una cuenta en una moneda espec√≠fica.

| Campo           | Tipo             | Restricciones                                       | Descripci√≥n |
|-----------------|------------------|-----------------------------------------------------|-------------|
| `money_id`      | INT              | **PK**, `IDENTITY(1,1)`                             | Identificador del registro de saldo. |
| `balance`       | DECIMAL(18,2)    | **NOT NULL**                                        | Saldo actual. Usa `DECIMAL` para evitar errores de coma flotante. |
| `account_id`    | UNIQUEIDENTIFIER | **NOT NULL**                                        | Identificador global de la cuenta (UUID). |
| `currency_code` | VARCHAR(10)      | **FK** ‚Üí `Currency(currency_code)`, **NOT NULL**    | C√≥digo de moneda (`USD`, `PEN`, `EUR`, ‚Ä¶). |
| `created_at`    | DATETIME2        | `DEFAULT SYSUTCDATETIME()`                          | Creaci√≥n (UTC). |
| `updated_at`    | DATETIME2        | `DEFAULT SYSUTCDATETIME()`                          | √öltima actualizaci√≥n (UTC). |

> **Nota:** En sistemas bancarios, `DECIMAL(18,2)` es un est√°ndar com√∫n. Ajustar escala seg√∫n negocio (p. ej., 4 decimales para FX).

---

### 2) Currency
Cat√°logo de monedas soportadas.

| Campo           | Tipo           | Restricciones                         | Descripci√≥n |
|-----------------|----------------|---------------------------------------|-------------|
| `currency_id`   | INT            | **PK**, `IDENTITY(1,1)`               | Identificador interno. |
| `currency_code` | VARCHAR(10)    | **UNIQUE**, **NOT NULL**              | C√≥digo ISO o interno de moneda. |
| `currency_name` | VARCHAR(100)   | **NOT NULL**                          | Nombre visible. |
| `created_at`    | DATETIME2      | `DEFAULT SYSUTCDATETIME()`            | Creaci√≥n (UTC). |
| `updated_at`    | DATETIME2      | `DEFAULT SYSUTCDATETIME()`            | √öltima actualizaci√≥n (UTC). |

---

### 3) OperationType
Cat√°logo de tipos de operaci√≥n.

| Campo            | Tipo          | Restricciones              | Descripci√≥n |
|------------------|---------------|----------------------------|-------------|
| `operation_id`   | INT           | **PK**, `IDENTITY(1,1)`    | Identificador interno. |
| `operation_code` | VARCHAR(20)   | **NOT NULL**               | C√≥digo (`SUM`, `REST`, `TRANSFER`, ‚Ä¶). |
| `created_at`     | DATETIME2     | `DEFAULT SYSUTCDATETIME()` | Creaci√≥n (UTC). |
| `updated_at`     | DATETIME2     | `DEFAULT SYSUTCDATETIME()` | √öltima actualizaci√≥n (UTC). |

---

### 4) Operations
Eventos de operaci√≥n entre saldos de `Money`.

| Campo             | Tipo      | Restricciones                                              | Descripci√≥n |
|-------------------|-----------|------------------------------------------------------------|-------------|
| `operation_id`    | INT       | **PK**, `IDENTITY(1,1)`                                    | Identificador del evento. |
| `operation_type`  | INT       | **FK** ‚Üí `OperationType(operation_id)`, **NOT NULL**       | Tipo de operaci√≥n. |
| `money_master`    | INT       | **FK** ‚Üí `Money(money_id)`, **NOT NULL**                   | Saldo origen/primario. |
| `money_secondary` | INT       | **FK** ‚Üí `Money(money_id)`, **NOT NULL**                   | Saldo destino/secundario. |
| `created_at`      | DATETIME2 | `DEFAULT SYSUTCDATETIME()`                                 | Creaci√≥n (UTC). |
| `updated_at`      | DATETIME2 | `DEFAULT SYSUTCDATETIME()`                                 | √öltima actualizaci√≥n (UTC). |

---

## üîó Relaciones
- `Money.currency_code` ‚Üí `Currency.currency_code`
- `Operations.operation_type` ‚Üí `OperationType.operation_id`
- `Operations.money_master` ‚Üí `Money.money_id`
- `Operations.money_secondary` ‚Üí `Money.money_id`

---

## üßæ DDL can√≥nica
> Mantener este bloque **id√©ntico** a la versi√≥n productiva y versionarlo en migraciones (Liquibase/Flyway).

```sql
USE Operation_Ms;

CREATE TABLE Money (
    [money_id] INT PRIMARY KEY IDENTITY(1, 1),
    [balance] DECIMAL(18,2) NOT NULL,
    [account_id] UNIQUEIDENTIFIER NOT NULL,
    [currency_code] VARCHAR(10) NOT NULL,
    [created_at] DATETIME2 DEFAULT SYSUTCDATETIME(),
    [updated_at] DATETIME2 DEFAULT SYSUTCDATETIME()
);

CREATE TABLE [Currency] (
    [currency_id] INT PRIMARY KEY IDENTITY(1, 1),
    [currency_code] VARCHAR(10) UNIQUE NOT NULL,
    [currency_name] VARCHAR(100) NOT NULL,
    [created_at] DATETIME2 DEFAULT SYSUTCDATETIME(),
    [updated_at] DATETIME2 DEFAULT SYSUTCDATETIME()
);

CREATE TABLE [OperationType] (
    [operation_id] INT PRIMARY KEY IDENTITY(1, 1),
    [operation_code] VARCHAR(20) NOT NULL,
    [created_at] DATETIME2 DEFAULT SYSUTCDATETIME(),
    [updated_at] DATETIME2 DEFAULT SYSUTCDATETIME()
);

CREATE TABLE [Operations] (
    [operation_id] INT PRIMARY KEY IDENTITY(1, 1),
    [operation_type] INT NOT NULL,
    [money_master] INT NOT NULL,
    [money_secondary] INT NOT NULL,
    [created_at] DATETIME2 DEFAULT SYSUTCDATETIME(),
    [updated_at] DATETIME2 DEFAULT SYSUTCDATETIME()
);

ALTER TABLE [Money]
  ADD FOREIGN KEY ([currency_code]) REFERENCES [Currency] ([currency_code]);

ALTER TABLE [Operations]
  ADD FOREIGN KEY ([operation_type]) REFERENCES [OperationType] ([operation_id]);

ALTER TABLE [Operations]
  ADD FOREIGN KEY ([money_master]) REFERENCES [Money] ([money_id]);

ALTER TABLE [Operations]
  ADD FOREIGN KEY ([money_secondary]) REFERENCES [Money] ([money_id]);
```

---

## üß© Convenciones y buenas pr√°cticas
- **Tipos de dinero**: `DECIMAL(18,2)` (o mayor escala si el negocio lo exige). Evitar `FLOAT/REAL`.
- **UTC** siempre en timestamps (`SYSUTCDATETIME()`).
- **Nombres** consistentes en ingl√©s para entidades y campos; `snake_case` o `lowerCamelCase` en aplicaciones, **no mezclar** estilos en un mismo espacio.
- **Migraciones** at√≥micas y reversibles (Liquibase/Flyway) por PR, ligadas al versionado del servicio.
- **Idempotencia** a nivel de aplicaci√≥n para operaciones financieras (p. ej., `operation_key` √∫nico por transacci√≥n si aplica).
- **Bloqueos**/aislamiento: para d√©bitos/cr√©ditos concurrentes, utilizar transacciones con el aislamiento apropiado (p. ej., `REPEATABLE READ`/`SERIALIZABLE`) o patrones como **Outbox** + **sagas**.
- **Validaciones** en capa de dominio (p. ej., impedir saldo negativo si es pol√≠tica), y **CHECK constraints** cuando sea invariante duro del modelo.

---

## ‚ö° √çndices recomendados
> No cambian el modelo, solo mejoran performance de lecturas frecuentes.

```sql
-- B√∫squedas por cuenta + moneda (consultas de saldo)
CREATE NONCLUSTERED INDEX IX_Money_Account_Currency
ON Money (account_id, currency_code);

-- Cat√°logo de operaciones (por c√≥digo)
CREATE NONCLUSTERED INDEX IX_OperationType_Code
ON OperationType (operation_code);

-- Join r√°pido por tipo
CREATE NONCLUSTERED INDEX IX_Operations_OperationType
ON Operations (operation_type);

-- Access patterns de transferencias (origen / destino)
CREATE NONCLUSTERED INDEX IX_Operations_MoneyMaster ON Operations (money_master);
CREATE NONCLUSTERED INDEX IX_Operations_MoneySecondary ON Operations (money_secondary);
```

> **Opcional (regla de unicidad de negocio):** si el negocio exige **un saldo por (account_id, currency_code)**, agregar:
```sql
ALTER TABLE Money
ADD CONSTRAINT UQ_Money_Account_Currency UNIQUE (account_id, currency_code);
```

---

## üå± Semillas (seed data)
```sql
INSERT INTO Currency (currency_code, currency_name) VALUES
 ('USD', 'US Dollar'),
 ('PEN', 'Peruvian Sol'),
 ('EUR', 'Euro');

INSERT INTO OperationType (operation_code) VALUES
 ('SUM'), ('REST'), ('TRANSFER');
```

---

## üîß Consultas de ejemplo

### Crear saldo
```sql
INSERT INTO Money (balance, account_id, currency_code)
VALUES (1000.00, NEWID(), 'USD');
```

### Transferencia simple (esbozo transaccional)
> Ejemplo did√°ctico; la l√≥gica de negocio e idempotencia se implementan en la capa de servicios.
```sql
BEGIN TRAN;

-- 1) Debitar origen
UPDATE m
   SET m.balance = m.balance - 50.00,
       m.updated_at = SYSUTCDATETIME()
  FROM Money m
 WHERE m.money_id = @money_master;

-- 2) Acreditar destino
UPDATE m
   SET m.balance = m.balance + 50.00,
       m.updated_at = SYSUTCDATETIME()
  FROM Money m
 WHERE m.money_id = @money_secondary;

-- 3) Registrar operaci√≥n
INSERT INTO Operations (operation_type, money_master, money_secondary)
VALUES (@operation_type, @money_master, @money_secondary);

COMMIT;
```

> **Tip:** aplicar `SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;` o usar **optimistic concurrency** (rowversion) seg√∫n throughput/conflictos.

---

## üöö Migraciones y CI/CD
- **Liquibase/Flyway**: scripts versionados por PR, con etiquetas por release.
- **Entornos**: `dev` ‚Üí `qa` ‚Üí `stage` ‚Üí `prod` con **gate** de aprobaciones.
- **Rollback**: cada cambio debe tener `--rollback` o script inverso.
- **Smoke tests**: verificaci√≥n autom√°tica post-deploy (integridad FK, conteo tablas, etc.).

---

## üîê Seguridad y accesos
- **Principio de m√≠nimo privilegio**: roles por responsabilidad (`reader`, `writer`, `admin`).
- Separar **esquema** l√≥gico (p. ej., `public`/`dbo`) por dominio si crece.
- **Enmascaramiento**/cifrado de datos sensibles a nivel de columna cuando aplique.
- Auditor√≠a de acciones privilegiadas (DDL/GRANT/REVOKE).

---

## ü©∫ Monitoreo y auditor√≠a
- Trazar m√©tricas: TPS de `Operations`, latencias, deadlocks.
- Dashboard con **errores de FK**, y **lag** de replicaci√≥n (si aplica).
- ETLs/backup: pol√≠tica de retenci√≥n y restauraciones probadas peri√≥dicamente.

---

## üß™ Estrategias de pruebas
- **Unit tests** de dominio (c√°lculos y reglas).
- **Contract tests** si este esquema es consumido por servicios (OpenAPI, CDC).
- **Data tests**: fixtures deterministas para QA.
- **Load tests** sobre consultas cr√≠ticas: lectura de saldos y escrituras concurrentes.

---

## üåü Mejoras futuras (opcionales)
- `rowversion` en tablas mutables para **concurrencia optimista**.
- `CHECK` de negocio (p. ej., `balance >= 0` si aplica).
- Tabla `OperationLedger` con montos y metadatos por operaci√≥n (importe, referencia externa, idempotency key).
- **Eventos Outbox** para publicarlos en Kafka tras confirmar la transacci√≥n SQL.
- Particionamiento por fecha si el volumen de `Operations` crece sustancialmente.

‚Äî Fin ‚Äî
